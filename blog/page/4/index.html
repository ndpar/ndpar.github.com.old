
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Side Notes</title>
  <meta name="author" content="Andrey Paramonov">

  
  <meta name="description" content="Installation Before installing ejabberd make sure you have Erlang environment set up. Run the following command and verify the output $ erl -version &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.ndpar.com/blog/page/4">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Side Notes" type="application/atom+xml">

  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>

  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

<!-- MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript"
   src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Side Notes</a></h1>
  
    <h2>never finished…</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.ndpar.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2010/02/23/get-started-with-ejabberd/">Get Started With Ejabberd</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-02-23T07:00:00-05:00" pubdate data-updated="true">Feb 23<span>rd</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2 id="installation">Installation</h2>

<p>Before installing ejabberd make sure you have Erlang environment set up. Run the following command and verify the output</p>

<pre><code>$ erl -version
Erlang (ASYNC_THREADS,HIPE) (BEAM) emulator version 5.10.1
</code></pre>

<p>I used to install ejabberd with apt-get command, which is convenient but always several versions behind. That’s why I switched to building from sources. All scripts below are assumed to be run under <em>ejabberd</em> user.</p>

<p>First, create a directory where all ejabberd versions will be installed, if it does not exist yet</p>

<pre><code>$ sudo mkdir /opt/ejabberd
$ sudo chown -R ejabberd /opt/ejabberd
</code></pre>

<p>Download the sources</p>

<pre><code>$ cd
$ git clone git@github.com:processone/ejabberd.git
$ cd ejabberd
</code></pre>

<p>Select version you want to install by executing <code>git branch -a</code> and <code>git tag --list</code> commands. Let assume we want to install version 2.1.12 from branch 2.1.x</p>

<pre><code>$ git checkout 2.1.x
$ cd src
</code></pre>

<p>The next step is optional. If you are going to integrate ejabberd with RabbitMQ, you need to download the source of rabbitmq-xmpp module</p>

<pre><code>$ wget https://raw.github.com/ndpar/rabbitmq-xmpp/rabbitmq3/src/mod_rabbitmq.erl
$ wget https://raw.github.com/ndpar/rabbitmq-xmpp/rabbitmq3/src/rabbit.hrl
</code></pre>

<p>Now we are ready to install ejabberd. To see all available configuration options, run <code>./configure --help</code>.</p>

<pre><code>$ ./configure --prefix=/opt/ejabberd/ejabberd-2.1.12 --enable-user=ejabberd
$ make
$ make install
$ cd /opt/ejabberd
$ ln -s ejabberd-2.1.12 ejabberd
</code></pre>

<h2 id="configuration">Configuration</h2>

<p>Ejabberd comes with reasonable default configuration. Only two lines need to be changed to make it work in your environment.</p>

<p>Open <em>/opt/ejabberd/ejabberd/etc/ejabberd/ejabberd.cfg</em> file and find <em>SERVED HOSTNAMES</em> section. By default Ejabberd is configured for localhost only. Change it to your machine’s DNS name. Here is what I have in my config</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>/opt/ejabberd/ejabberd/etc/ejabberd/ejabberd.cfg </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="erlang"><span class="line"><span class="c">%%%&#39;   SERVED HOSTNAMES</span>
</span><span class="line"><span class="p">{</span><span class="n">hosts</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;jabber.ndpar.com&quot;</span><span class="p">]}.</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The second thing we need to do is to configure admin user. Here is mine, registered for the host I just defined</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>/opt/ejabberd/ejabberd/etc/ejabberd/ejabberd.cfg </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="erlang"><span class="line"><span class="c">%%%&#39;   ACCESS CONTROL LISTS</span>
</span><span class="line"><span class="p">{</span><span class="n">acl</span><span class="p">,</span> <span class="n">admin</span><span class="p">,</span> <span class="p">{</span><span class="n">user</span><span class="p">,</span> <span class="s">&quot;andrey&quot;</span><span class="p">,</span> <span class="s">&quot;jabber.ndpar.com&quot;</span><span class="p">}}.</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Save the config file and start the server</p>

<pre><code>$ /opt/ejabberd/ejabberd/sbin/ejabberdctl start
</code></pre>

<p>You can quickly check the log file to see if the server has been started successfully</p>

<pre><code>$ less /opt/ejabberd/ejabberd/var/log/ejabberd/ejabberd.log
</code></pre>

<p>If it wasn’t, you might want to enable debug logs</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>/opt/ejabberd/ejabberd/etc/ejabberd/ejabberd.cfg </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="erlang"><span class="line"><span class="c">%%%&#39;   DEBUGGING</span>
</span><span class="line"><span class="p">{</span><span class="n">loglevel</span><span class="p">,</span> <span class="mi">5</span><span class="p">}.</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>and restart the server to see more details</p>

<pre><code>$ /opt/ejabberd/ejabberd/sbin/ejabberdctl restart
</code></pre>

<h2 id="registering-users">Registering users</h2>

<p>The first (admin) user has to be registered in command line</p>

<pre><code>$ cd /opt/ejabberd/ejabberd/sbin
$ ./ejabberdctl register andrey jabber.ndpar.com ******
</code></pre>

<p>This user is the same as admin you configured in the previous section. If you go to <a href="http://localhost:5280/admin">localhost:5280/admin</a> in the browser, you should be able to login with the same password you registered the user</p>

<p><img class="center" src="/images/posts/ejabberd-web.png" /></p>

<p>Now you are ready to add newly created account to your Jabber client. In Adium, for example, go to <em>File</em> -&gt; <em>Add Acount</em> -&gt; <em>Jabber</em> and provide server hostname/IP, JID and password.</p>

<p><img class="center" src="/images/posts/ejabberd-adium-1.png" /></p>

<p><img class="center" src="/images/posts/ejabberd-adium-2.png" /></p>

<p>To really enjoy IM you need more users on your server. The best part here is that you can create new users just from your Jabber client. Simply go to <em>File</em> -&gt; <em>your ejabberd account</em> -&gt; <em>Add User</em></p>

<p><img class="center" src="/images/posts/ejabberd-admin-client.png" /></p>

<p>For other available options please consult <a href="http://www.ejabberd.im">official documentation</a>.</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/11/12/state-machine-in-erlang/">State Machine in Erlang</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-11-12T10:43:00-05:00" pubdate data-updated="true">Nov 12<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>There is some sort of confusion in the object-oriented community about functional languages. How is it possible to implement stateful application if the language has no concept of state? It turns out that it’s actually quite possible, although the solution is completely deferent from what we see in the OO realm. In Erlang, for example, state can be implemented by using <em>process message passing</em> and <em>tail recursion</em>. This approach is so elegant that after you’ve learned it, the OO way of doing this looks unnatural. The code below is the Erlang implementation of Uncle Bob’s <a href="http://www.objectmentor.com/resources/articles/umlfsm.pdf">FSM example</a>. Look at it. Isn’t that code clean and expressive? It looks almost like DSL but it’s actually regular Erlang syntax.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
</pre></td><td class="code"><pre><code class="erlang"><span class="line"><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">turnstile</span><span class="p">).</span>
</span><span class="line"><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
</span><span class="line"><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">coin</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span> <span class="n">pass</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
</span><span class="line"><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">init</span><span class="o">/</span><span class="mi">0</span><span class="p">]).</span>
</span><span class="line">
</span><span class="line"><span class="nf">start</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">register</span><span class="p">(</span><span class="n">turnstile</span><span class="p">,</span> <span class="nb">spawn</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="p">[])).</span>
</span><span class="line">
</span><span class="line"><span class="c">% Initial state</span>
</span><span class="line">
</span><span class="line"><span class="nf">init</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">locked</span><span class="p">().</span>
</span><span class="line">
</span><span class="line"><span class="c">% Events</span>
</span><span class="line">
</span><span class="line"><span class="nf">coin</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">turnstile</span> <span class="o">!</span> <span class="n">coin</span><span class="p">.</span>
</span><span class="line"><span class="nf">pass</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">turnstile</span> <span class="o">!</span> <span class="n">pass</span><span class="p">.</span>
</span><span class="line">
</span><span class="line"><span class="c">% States and transitions</span>
</span><span class="line">
</span><span class="line"><span class="nf">locked</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="k">receive</span>
</span><span class="line">        <span class="n">pass</span> <span class="o">-&gt;</span>
</span><span class="line">            <span class="n">alarm</span><span class="p">(),</span>
</span><span class="line">            <span class="n">locked</span><span class="p">();</span>
</span><span class="line">        <span class="n">coin</span> <span class="o">-&gt;</span>
</span><span class="line">            <span class="n">unlock</span><span class="p">(),</span>
</span><span class="line">            <span class="n">unlocked</span><span class="p">()</span>
</span><span class="line">    <span class="k">end</span><span class="p">.</span>
</span><span class="line">
</span><span class="line"><span class="nf">unlocked</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="k">receive</span>
</span><span class="line">        <span class="n">pass</span> <span class="o">-&gt;</span>
</span><span class="line">            <span class="n">lock</span><span class="p">(),</span>
</span><span class="line">            <span class="n">locked</span><span class="p">();</span>
</span><span class="line">        <span class="n">coin</span> <span class="o">-&gt;</span>
</span><span class="line">            <span class="n">thankyou</span><span class="p">(),</span>
</span><span class="line">            <span class="n">unlocked</span><span class="p">()</span>
</span><span class="line">    <span class="k">end</span><span class="p">.</span>
</span><span class="line">
</span><span class="line"><span class="c">% Actions</span>
</span><span class="line">
</span><span class="line"><span class="nf">alarm</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;You shall not pass!</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">).</span>
</span><span class="line"><span class="nf">unlock</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Unlocking...</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">).</span>
</span><span class="line"><span class="nf">lock</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Locking...</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">).</span>
</span><span class="line"><span class="nf">thankyou</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nn">io</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Thank you for donation</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">).</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The idea behind this code is simple. Every state is implemented as a function that does two things: it listens for messages sent by other processes; when message is received the appropriate action is taken and one of the <em>state-functions called recursively</em>. Simple.</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/10/22/parsing-files-using-groovy-regex/">Parsing Files Using Groovy Regex</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-10-22T08:00:00-04:00" pubdate data-updated="true">Oct 22<span>nd</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In my previous <a href="/2009/09/25/groovy-regular-expressions/">post</a> I mentioned several ways of defining regular expressions in Groovy. Here I want to show how we can use Groovy regex to find the data in the files.</p>

<h2 id="parsing-properties-file-simplifiedsup1sup">Parsing properties file (simplified)<sup>1</sup></h2>

<p><em>Data:</em> each line in the file has the same structure; the entire line can be matched by single regex.</p>

<p><em>Task:</em> transform each line to the object.</p>

<p><em>Solution:</em> construct regex with capturing parentheses, apply it to each line, extract captured data.</p>

<p><em>Demonstrates:</em> <code>File.eachLine</code> method, matrix syntax of <em>Matcher</em> object.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="groovy"><span class="line"><span class="kt">def</span> <span class="n">properties</span> <span class="o">=</span> <span class="o">[:]</span>
</span><span class="line"><span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="s1">&#39;path/to/some.properties&#39;</span><span class="o">).</span><span class="na">eachLine</span> <span class="o">{</span> <span class="n">line</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="k">if</span> <span class="o">((</span><span class="n">matcher</span> <span class="o">=</span> <span class="n">line</span> <span class="o">=~</span> <span class="s">/^([^#=].*?)=(.+)$/</span><span class="o">))</span> <span class="o">{</span>
</span><span class="line">        <span class="n">properties</span><span class="o">[</span><span class="n">matcher</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="mi">1</span><span class="o">]]</span> <span class="o">=</span> <span class="n">matcher</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="mi">2</span><span class="o">]</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line"><span class="n">println</span> <span class="n">properties</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="parsing-csv-files-simplifiedsup2sup">Parsing CSV files (simplified)<sup>2</sup></h2>

<p><em>Data:</em> each line in the file has the same structure; the line consists of the blocks separated by some character sequence.</p>

<p><em>Task:</em> transform each line to the list of objects.</p>

<p><em>Solution:</em> construct regex with capturing parentheses, parse each line with the regex in a loop extracting captured data.</p>

<p><em>Demonstrates:</em> <code>~//</code> <em>Pattern</em> defenition, <code>Matcher.group</code> method, <code>\G</code> regex meta-sequence.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="groovy"><span class="line"><span class="kt">def</span> <span class="n">regex</span> <span class="o">=</span> <span class="o">~</span><span class="s">/\G(?:^|,)(?:&quot;([^&quot;]*+)&quot;|([^&quot;,]*+))/</span>
</span><span class="line"><span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="s1">&#39;path/to/file.csv&#39;</span><span class="o">).</span><span class="na">eachLine</span> <span class="o">{</span> <span class="n">line</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="kt">def</span> <span class="n">fields</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class="line">    <span class="kt">def</span> <span class="n">matcher</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">line</span><span class="o">)</span>
</span><span class="line">    <span class="k">while</span> <span class="o">(</span><span class="n">matcher</span><span class="o">.</span><span class="na">find</span><span class="o">())</span> <span class="o">{</span>
</span><span class="line">        <span class="n">fields</span> <span class="o">&lt;&lt;</span> <span class="o">(</span><span class="n">matcher</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">?:</span> <span class="n">matcher</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">2</span><span class="o">))</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="n">println</span> <span class="n">fields</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="finding-snapshot-dependencies-in-the-pom-simplifiedsup3sup">Finding snapshot dependencies in the POM (simplified)<sup>3</sup></h2>

<p><em>Data:</em> file contains blocks with known boundaries (possibly spanning multiple lines).</p>

<p><em>Task:</em> extract the blocks satisfying some criteria.</p>

<p><em>Solution:</em> read the entire file into the string, construct regex with capturing parentheses, apply the regex to the string in a loop.</p>

<p><em>Demonstrates:</em> <code>File.text</code> property, list syntaxt of <em>Matcher</em> object, named capture, global <code>\x</code> regex modifier, local <code>\s</code> regex modifier.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="groovy"><span class="line"><span class="kt">def</span> <span class="n">pom</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s1">&#39;path/to/pom.xml&#39;</span><span class="o">).</span><span class="na">text</span>
</span><span class="line"><span class="kt">def</span> <span class="n">matcher</span> <span class="o">=</span> <span class="n">pom</span> <span class="o">=~</span> <span class="s">$/(?x)</span>
</span><span class="line"><span class="s">    &lt;dependency&gt;                          \s*</span>
</span><span class="line"><span class="s">      &lt;groupId&gt;([^&lt;]+)&lt;/groupId&gt;          \s*</span>
</span><span class="line"><span class="s">      &lt;artifactId&gt;([^&lt;]+)&lt;/artifactId&gt;    \s*</span>
</span><span class="line"><span class="s">      &lt;version&gt;(.+?-SNAPSHOT)&lt;/version&gt;   (?s:.*?)</span>
</span><span class="line"><span class="s">    &lt;/dependency&gt;</span>
</span><span class="line"><span class="s">/$</span>
</span><span class="line"><span class="n">matcher</span><span class="o">.</span><span class="na">each</span> <span class="o">{</span> <span class="n">matched</span><span class="o">,</span> <span class="n">groupId</span><span class="o">,</span> <span class="n">artifactId</span><span class="o">,</span> <span class="n">version</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="n">println</span> <span class="s2">&quot;$groupId:$artifactId:$version&quot;</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="finding-stacktraces-in-the-log">Finding stacktraces in the log</h2>

<p><em>Data:</em> file contains entries each of which starts with the same pattern and can span multiple lines. Typical example is log4j log files:</p>

<pre><code>2009-10-16 15:32:12,157 DEBUG [com.ndpar.web.RequestProcessor] Loading user
2009-10-16 15:32:13,258 ERROR [com.ndpar.web.UserController] id to load is required for loading
java.lang.IllegalArgumentException: id to load is required for loading
     at org.hibernate.event.LoadEvent.(LoadEvent.java:74)
     at org.hibernate.event.LoadEvent.(LoadEvent.java:56)
     at org.hibernate.impl.SessionImpl.get(SessionImpl.java:839)
     at org.hibernate.impl.SessionImpl.get(SessionImpl.java:835)
     at org.springframework.orm.hibernate3.HibernateTemplate$1.doInHibernate(HibernateTemplate.java:531)
     at org.springframework.orm.hibernate3.HibernateTemplate.doExecute(HibernateTemplate.java:419)
     at org.springframework.orm.hibernate3.HibernateTemplate.executeWithNativeSession(HibernateTemplate.java:374)
     at org.springframework.orm.hibernate3.HibernateTemplate.get(HibernateTemplate.java:525)
     at org.springframework.orm.hibernate3.HibernateTemplate.get(HibernateTemplate.java:519)
     at com.ndpar.dao.UserManager.getUser(UserManager.java:90)
     ... 62 more
2009-10-16 15:32:14,659 DEBUG [com.ndpar.jms.MessageListener] Received message:
     ... multi-line message ...
2009-10-16 15:32:15,169 INFO  [com.ndpar.dao.UserManager] User: ...
</code></pre>

<p><em>Task:</em> find entries satisfying some criteria.</p>

<p><em>Solution:</em> read the entire file into the string<sup>4</sup>, construct regex with capturing parentheses and lookahead, split the string into entries, loop through the result and apply criteria to each entry.</p>

<p><em>Demonstrates:</em> regex interpolation, combined global regex modifiers <code>\s</code> and <code>\m</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="groovy"><span class="line"><span class="kt">def</span> <span class="n">log</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s1">&#39;path/to/your.log&#39;</span><span class="o">).</span><span class="na">text</span>
</span><span class="line"><span class="kt">def</span> <span class="n">logLineStart</span> <span class="o">=</span> <span class="s">/^\d{4}-\d{2}-\d{2}/</span>
</span><span class="line"><span class="kt">def</span> <span class="n">splitter</span> <span class="o">=</span> <span class="n">log</span> <span class="o">=~</span> <span class="s">$/(?xms)</span>
</span><span class="line"><span class="s">    (    ${logLineStart}   .*?)</span>
</span><span class="line"><span class="s">    (?=  ${logLineStart} | \Z)</span>
</span><span class="line"><span class="s">/$</span>
</span><span class="line"><span class="n">splitter</span><span class="o">.</span><span class="na">each</span> <span class="o">{</span> <span class="n">matched</span><span class="o">,</span> <span class="n">entry</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">entry</span> <span class="o">=~</span> <span class="s">/(?m)^(?:\t| {8})at/</span><span class="o">)</span> <span class="n">println</span> <span class="n">entry</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="resources">Resources</h3>

<ul>
  <li>Groovy <a href="http://groovy.codehaus.org/Regular+Expressions">regexes</a></li>
  <li>Groovy <a href="http://groovy.codehaus.org/Groovy+CLI">one-liners</a></li>
  <li>Using <a href="http://mrhaki.blogspot.com/2009/10/groovy-goodness-using-replaceall.html">String.replaceAll</a> method</li>
</ul>

<h3 id="footnotes">Footnotes</h3>

<ol>
  <li>This example is for demonstration purposes only. In real program you would just use <code>Properties.load</code> method.</li>
  <li>The regex is simplified. If you want the real one, take a look at Jeffrey Friedl’s <a href="http://regex.info/listing.cgi?ed=3&amp;p=401">example</a>.</li>
  <li>Again, in reality you would find snapshots using <code>mvn dependency:resolve | grep SNAPSHOT</code> command.</li>
  <li>This approach won’t work for big files. Take a look at this <a href="http://github.com/ndpar/utilities/blob/master/stacktraces.groovy">script</a> for practical solution.</li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/09/25/groovy-regular-expressions/">Groovy Regular Expressions</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-09-25T08:00:00-04:00" pubdate data-updated="true">Sep 25<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Because of the compact syntax regular expressions in Groovy are more readable than in Java. Here is how Jeffrey Friedl’s <a href="http://regex.info/listing.cgi?ed=3&amp;p=208">example</a> looks in Groovy:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
</pre></td><td class="code"><pre><code class="groovy"><span class="line"><span class="kt">def</span> <span class="n">subDomain</span>  <span class="o">=</span> <span class="s1">&#39;(?i:[a-z0-9]|[a-z0-9][-a-z0-9]*[a-z0-9])&#39;</span> <span class="c1">// simple regex in single quotes</span>
</span><span class="line"><span class="kt">def</span> <span class="n">topDomains</span> <span class="o">=</span> <span class="s">$/</span>
</span><span class="line"><span class="s">    (?x-i : com         \b     # you can put whitespaces and comments</span>
</span><span class="line"><span class="s">          | edu         \b     # inside regex in eXtended mode</span>
</span><span class="line"><span class="s">          | biz         \b</span>
</span><span class="line"><span class="s">          | in(?:t|fo)  \b     # backslash is not escaped</span>
</span><span class="line"><span class="s">          | mil         \b     # in dollar-slash strings</span>
</span><span class="line"><span class="s">          | net         \b</span>
</span><span class="line"><span class="s">          | org         \b</span>
</span><span class="line"><span class="s">          | [a-z][a-z]  \b</span>
</span><span class="line"><span class="s">    )/$</span>
</span><span class="line">
</span><span class="line"><span class="kt">def</span> <span class="n">hostname</span> <span class="o">=</span> <span class="s">/(?:${subDomain}\.)+${topDomains}/</span>  <span class="c1">// variable substitution in slashy string</span>
</span><span class="line">
</span><span class="line"><span class="kt">def</span> <span class="n">NOT_IN</span>   <span class="o">=</span> <span class="s">/;\&quot;&#39;&lt;&gt;()\[\]{}\s\x7F-\xFF/</span>     <span class="c1">// backslash is not escaped in slashy strings</span>
</span><span class="line"><span class="kt">def</span> <span class="n">NOT_END</span>  <span class="o">=</span> <span class="s">/!.,?/</span>
</span><span class="line"><span class="kt">def</span> <span class="n">ANYWHERE</span> <span class="o">=</span> <span class="s">/[^${NOT_IN}${NOT_END}]/</span>
</span><span class="line"><span class="kt">def</span> <span class="n">EMBEDDED</span> <span class="o">=</span> <span class="s">/[$NOT_END]/</span>                        <span class="c1">// you can ommit {} around var name</span>
</span><span class="line">
</span><span class="line"><span class="kt">def</span> <span class="n">urlPath</span>  <span class="o">=</span> <span class="s2">&quot;/$ANYWHERE*($EMBEDDED+$ANYWHERE+)*&quot;</span>
</span><span class="line">
</span><span class="line"><span class="kt">def</span> <span class="n">url</span> <span class="o">=</span>
</span><span class="line">    <span class="s2">&quot;&quot;&quot;(?x:</span>
</span><span class="line"><span class="s2">             # you have to escape backslash in multi-line double quotes</span>
</span><span class="line"><span class="s2">             \\b</span>
</span><span class="line">
</span><span class="line"><span class="s2">             # match the hostname part</span>
</span><span class="line"><span class="s2">             (</span>
</span><span class="line"><span class="s2">               (?: ftp | http s? ): // [-\\w]+(\\.\\w[-\\w]*)+</span>
</span><span class="line"><span class="s2">             |</span>
</span><span class="line"><span class="s2">               $hostname</span>
</span><span class="line"><span class="s2">             )</span>
</span><span class="line">
</span><span class="line"><span class="s2">             # allow optional port</span>
</span><span class="line"><span class="s2">             (?: :\\d+ )?</span>
</span><span class="line">
</span><span class="line"><span class="s2">             # rest of url is optional, and begins with /</span>
</span><span class="line"><span class="s2">             (?: $urlPath )?</span>
</span><span class="line"><span class="s2">       )&quot;&quot;&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">assert</span> <span class="s1">&#39;http://www.google.com/search?rls=en&amp;q=regex&amp;ie=UTF-8&amp;oe=UTF-8&#39;</span> <span class="o">==~</span> <span class="n">url</span>
</span><span class="line"><span class="k">assert</span> <span class="s1">&#39;pages.github.io&#39;</span> <span class="o">==~</span> <span class="n">url</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>As you can see, there are several notations, and for every subexpression you can choose the one that is most expressive.</p>

<h3 id="resources">Resources</h3>

<ul>
  <li>Martin Fowler on <a href="http://martinfowler.com/bliki/ComposedRegex.html">composed regexes</a></li>
  <li><a href="http://jira.codehaus.org/browse/GROOVY-2701">Introducing dollar-slash</a> notation into Groovy</li>
  <li><a href="http://regex.info/">Mastering Regular Expressions</a> — the best regex book</li>
  <li>Groovy <a href="http://mrhaki.blogspot.com/2009/09/groovy-goodness-using-regular.html">Pattern</a> and <a href="http://mrhaki.blogspot.com/2009/09/groovy-goodness-matchers-for-regular.html">Matcher</a> classes</li>
</ul>

</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/3/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2013/07/28/java-12pm-bug/">12PM Bug in Java</a>
      </li>
    
      <li class="post">
        <a href="/2013/06/11/sleeping-barber-in-erlang/">Sleeping Barber in Erlang</a>
      </li>
    
      <li class="post">
        <a href="/2013/05/26/entrepreneur/">To Be or Not to Be… Entrepreneur</a>
      </li>
    
      <li class="post">
        <a href="/2013/05/21/joe-armstrong-mostlyerlang/">Joe Armstrong at MostlyErlang</a>
      </li>
    
      <li class="post">
        <a href="/2013/05/09/liskov-programming-abstraction/">Stuck With Your First Programming Language</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Recent GitHub Updates</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'ndpar',
            count: 4,
            skip_forks: false,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>




<section>
  <h1>Categories</h1>
  <ul id="categories">
    <li class='category'><a href='/categories/activemq/'>ActiveMQ (1)</a></li>
<li class='category'><a href='/categories/agile/'>Agile (1)</a></li>
<li class='category'><a href='/categories/art/'>Art (1)</a></li>
<li class='category'><a href='/categories/book-review/'>Book Review (1)</a></li>
<li class='category'><a href='/categories/buzz/'>Buzz (2)</a></li>
<li class='category'><a href='/categories/clojure/'>Clojure (3)</a></li>
<li class='category'><a href='/categories/clustering/'>Clustering (1)</a></li>
<li class='category'><a href='/categories/conference/'>Conference (2)</a></li>
<li class='category'><a href='/categories/craftsmanship/'>Craftsmanship (1)</a></li>
<li class='category'><a href='/categories/education/'>Education (1)</a></li>
<li class='category'><a href='/categories/ejabberd/'>Ejabberd (2)</a></li>
<li class='category'><a href='/categories/entrepreneurship/'>Entrepreneurship (1)</a></li>
<li class='category'><a href='/categories/erlang/'>Erlang (6)</a></li>
<li class='category'><a href='/categories/functional-programming/'>Functional Programming (1)</a></li>
<li class='category'><a href='/categories/git/'>Git (2)</a></li>
<li class='category'><a href='/categories/grails/'>Grails (1)</a></li>
<li class='category'><a href='/categories/groovy/'>Groovy (10)</a></li>
<li class='category'><a href='/categories/humor/'>Humor (2)</a></li>
<li class='category'><a href='/categories/java/'>Java (4)</a></li>
<li class='category'><a href='/categories/lisp/'>Lisp (2)</a></li>
<li class='category'><a href='/categories/math/'>Math (4)</a></li>
<li class='category'><a href='/categories/maven/'>Maven (1)</a></li>
<li class='category'><a href='/categories/mongodb/'>MongoDB (1)</a></li>
<li class='category'><a href='/categories/nosql/'>NoSQL (1)</a></li>
<li class='category'><a href='/categories/programming/'>Programming (6)</a></li>
<li class='category'><a href='/categories/python/'>Python (2)</a></li>
<li class='category'><a href='/categories/rabbitmq/'>RabbitMQ (4)</a></li>
<li class='category'><a href='/categories/regex/'>Regex (2)</a></li>
<li class='category'><a href='/categories/solr/'>Solr (1)</a></li>
<li class='category'><a href='/categories/spring/'>Spring (1)</a></li>
<li class='category'><a href='/categories/tutorial/'>Tutorial (1)</a></li>
<li class='category'><a href='/categories/zeromq/'>ZeroMQ (1)</a></li>
<li class='category'><a href='/categories/zookeeper/'>ZooKeeper (1)</a></li>

  </ul>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2009–2013 - Andrey Paramonov -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> -
  <span class="credit">Hosted by <a href="http://github.com">GitHub</a></span>
</p>

</footer>
  











</body>
</html>
