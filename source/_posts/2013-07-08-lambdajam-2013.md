---
layout:     post
title:      "Lambda Jam 2013"
date:       2013-07-08 09:00:00
categories: [Clojure,Conference,Erlang,Haskell,Math,Scala]
tags:       [clojure,erlang]
published:  false
---

## Prelude

This is my impressionistic non-canonical irregular Clojuresque-Erlangish notes on [Lambda Jam](http://lambdajam.com) conference which happened in Chicago on July 8–10, 2013.
These notes are pretty long, and I don't split them on purpose.
If you read them all, you should become overwhelmed and overloaded with the information.
Only this way you can feel the same I felt on the last day of the conference :)

{% img http://lambdajam.com/storage/2013/GrandBallroom2_header.jpg.jpeg?__SQUARESPACE_CACHEVERSION=1361043346973 %}

<!-- more -->

## Stuart Sierra — Data, Visibility, and Abstraction

* Video: [InfoQ](http://www.infoq.com/presentations/data-visibility-abstraction)

### Quotes

* QBasic distinguished between subroutines and functions.
* Perl is a QBasic of Linux.
* Perl provided bunch of abstractions that made my life easier.
* Just a few generic data structures can represent pretty much any kind of data.

{% codeblock lang:perl %}
#!/usr/bin/env perl

my $user =
  { name  => "Stuart",
    age   => 15,
    langs => [ "BASIC",
               "C++",
               "Perl" ] };

print $user->{'langs'}[2];
{% endcodeblock %}

* `Tie::File` — Access the lines of a disk file via a Perl array.
* XSLT is a homoiconic programming language.
* [In XSLT] you can write the entire program as a series of data transformations.

{% codeblock lang:bash %}
#!/usr/bin/env bash
saxon one.xslt site.xml t1.xml
saxon two.xslt t1.xml t2.xml
saxon three.xslt t2.xml t3.xml
saxon four.xslt t3.xml index.html
{% endcodeblock %}

* Clojure has universal data structures.

{% codeblock lang:clojure %}
(def user {:name "Stuart"
           :age 25
           :langs ["Lisp"
                   "Ruby"
                   "Clojure"]})
{% endcodeblock %}

* I'm frequently suspicious of libraries that use a lot of macros to create their abstractions because it means I can't see them, I can't manipulate them with the tools I already have.

{% codeblock lang:clojure %}
(require 'clojure.inspector)
(clojure.inspector/inspect-tree user)
{% endcodeblock %}

{% img center /images/posts/clojure.inspector.png %}

* I started to write my programs as a series of data transformations with just one set of side-effects at the very end.

{% codeblock lang:clojure %}
(defn gather-information [state]
  (assoc state :analysis
               (computation (:input state))))

(defn make-decision [state]
  (assoc state :response
               (if (condition? (:analysis state))
                   :launch-missile
                   :erase-hard-drive)))

(defn take-action [state]
  (case (:response state)
    :launch-missile (launch-missile)
    :erase-hard-drive (erase-hard-drive)))

(defn complex-process [initial-state]
  (-> initial-state
      gather-information
      make-decision
      take-action))
{% endcodeblock %}

* I try to pursue abstractions that make programs more visible, make easier to see what the program is doing.

{% blockquote Edsger W. Dijkstra %}
Being abstract is something profoundly different from being vague…

The purpose of abstraction is not to be vague, but to create a new semantic level in which one can be absolutely precise.
{% endblockquote %}


## Aditya Siram — Simile-Free Monad Recipes

* [Slides](https://github.com/strangeloop/lambdajam2013/blob/master/slides/Siram-SimileFreeMonadRecipes.pdf)

### Non-idiomatic Haskell monad tutorial

Working with monads is a switching between monadic and non-monadic context.

### IO

* `<-` operator gets the value from monadic context.
* `return` puts the value into monadic context.

{% codeblock lang:haskell %}
main :: IO ()
main = do
  writeFile "test.txt" "a,b,c,d,e" :: IO ()
  x :: String <- readFile "test.txt" :: IO String
  let upCased :: String = map toUpper x
  y :: String <- return upCased :: IO String
  print y :: IO ()
{% endcodeblock %}

### Reader

* Reader = Read-only State + Result
* `runReader` :: Reader Monad -> Read-Only State -> Result
* `ask` extracts the state from the monad for inspection.

### Writer

* Writer = Append-Only State + Result
* `runWriter` :: Writer Monad -> (Result, Accumulated State)
* State is accumulated using `tell`.

### State

* State Monad = Mutable State + Result
* `get`, `put` do what they sound like.
* `runState` :: State Monad -> Initial State -> (Result, New State)
* Initial State is required.


## Dean Wampler — Copious Data, the "Killer App" for FP

* Slides: [GitHub](https://github.com/strangeloop/lambdajam2013/blob/master/slides/Wampler-CopiousDataTheKillerAppForFP.pdf)
* Video: [InfoQ](http://www.infoq.com/presentations/big-data-functional-programming)

### Quotes

* It’s hard to implement many algorithms in MapReduce.
* MapReduce is very course-grained.
* For Hadoop in particularly, the Java API is hard to use.

* Hadoop is the EJBs of our time

{% codeblock lang:java %}
import org.apache.hadoop.io.*;
import org.apache.hadoop.mapred.*;
import java.util.*;

class WCMapper extends MapReduceBase
    implements Mapper<LongWritable, Text, Text, IntWritable> {

    static final IntWritable one = new IntWritable(1);
    static final Text word = new Text(); // Value will be set in a non-thread-safe way!

    @Override
    public void map(LongWritable key, Text valueDocContents,
            OutputCollector<Text, IntWritable> output, Reporter reporter) {
        String[] tokens = valueDocContents.toString().split("\\s+");
        for (String wordString: tokens) {
            if (wordString.length > 0) {
                word.set(wordString.toLowerCase());
                output.collect(word, one);
            }
        }
    }
}

class Reduce extends MapReduceBase
    implements Reducer<Text, IntWritable, Text, IntWritable> {

    public void reduce(Text keyWord, Iterator<IntWritable> valuesCounts,
            OutputCollector<Text, IntWritable> output, Reporter reporter) {
        int totalCount = 0;
        while (valuesCounts.hasNext()) {
            totalCount += valuesCounts.next().get();
        }
        output.collect(keyWord, new IntWritable(totalCount));
    }
}
{% endcodeblock %}

* Use Cascalog

{% codeblock lang:clojure %}
(defn lowercase [w] (.toLowerCase w))

(?<- (stdout) [?word ?count]
  (sentence ?s)
    (split ?s :> ?word1)
  (lowercase ?word1 :> ?word)
    (c/count ?count))
{% endcodeblock %}

* Use Spark

{% codeblock lang:scala %}
object WordCountSpark {
    def main(args: Array[String]) {
        val file = spark.textFile(args(0))
        val counts = file.flatMap(line => line.split("\\W+"))
                         .map(word => (word, 1))
                         .reduceByKey(_ + _)
        counts.saveAsTextFile(args(1))
    }
}
{% endcodeblock %}

* Data problems are fundamentally Mathematics!
* Data will drive widespread FP adoption.

### Resources

* [Cascading](http://www.cascading.org) — an application framework for Java developers to simply develop Data Analytics applications on Hadoop.
* Nathan Marz — Introducing Cascalog: a Clojure-based query language for Hadoop [[blogpost](http://nathanmarz.com/blog/introducing-cascalog-a-clojure-based-query-language-for-hado.html)].
* [Spark](http://spark-project.org) — an open source cluster computing system that aims to make data analytics fast.
* Evan Miller — The Mathematical Hacker [[blogpost](http://www.evanmiller.org/mathematical-hacker.html)].


## Jam

A jam is similar to a code retreat, only you work in groups instead of pairs. It starts with a problem description. Then you form a group and work on the problem for 3 hours. In the end you share your experience with the audience.

The problem of the first jam was Peter Norvig's [Spelling Corrector](http://norvig.com/spell-correct.html). I was wandering the room looking for an Erlang group to join when I bumped into this bunch of wonderful people: [Bruce Adams](https://twitter.com/Bruce_Adams), [Joe Armstrong](https://twitter.com/joeerl), [Garrett Smith](https://twitter.com/gar1t), [Bryan Hunter](https://twitter.com/bryan_hunter), and [Karl Grzeszczak](https://twitter.com/karl_grz).

{% img center https://pbs.twimg.com/media/BOrdEK6CYAA2zlb.jpg %}

Soon the jam transformed into an Erlang master class from Joe Armstrong. We were watching the master's work flow, his way of thinking, learning his tips and tricks, listening to his brilliant remarks about Erlang and Haskell.

{% img center https://pbs.twimg.com/media/BOrk-wfCEAE3kKr.jpg %}

At some point I said how elegant was the function Joe Armstrong just implemented, on which he replied

> There is not much intelligence here. It's all about practice.

<blockquote class="twitter-tweet" align="center"><p>Today I watched <a href="https://twitter.com/joeerl">@joeerl</a> implementing a parallel spell checker in Erlang. That was worth the price of admission alone. Thank you! <a href="https://twitter.com/search?q=%23LambdaJam&amp;src=hash">#LambdaJam</a></p>&mdash; Karl Grzeszczak (@karl_grz) <a href="https://twitter.com/karl_grz/statuses/354386650291380224">July 8, 2013</a></blockquote>

### Resources

* [Source code](https://github.com/ericnormand/spelling-jam/blob/master/code/erlang/spell.erl)


## Joe Armstrong — Keynote

### Systems That Run Forever Self-Heal and Scale

* Slides: [GitHub](https://github.com/strangeloop/lambdajam2013/blob/master/slides/Armstrong-SystemsThatRunForever.pdf)
* Video: [InfoQ](http://www.infoq.com/presentations/self-heal-scalable-system)

### Quotes


* I'm not interested in programming languages. I'm interested in solving problems.
* Primary goal Erlang was designed for is the fault-talerant computation.
* I think it's a bad idea to design your system for 10 people and then scale it up for 10,000. It's better to design it for 10M and scale it down.
* The difficult part of making reliable system is to make multiple machines work independently in parallel.

Why distributed programming is hard

1. Difficulty in identifying and dealing with failures.
1. Achieving consistency in data across processes.
1. Heterogeneous nature of the components involved in the system.
1. Testing a distributed system is quite difficult.
1. The technologies involved in distributed systems are not easy to understand.

*Chord* algorithm: distributing data across several machines

{% codeblock lang:bash %}
S1 IP = 235.23.34.12
S2 IP = 223.23.141.53
S3 IP = 122.67.12.23

md5(ip(s1)) = C82D4DB065065DBDCDADFBC5A727208E
md5(ip(s2)) = 099340C20A42E004716233AB216761C3
md5(ip(s3)) = A0E607462A563C4D8CCDB8194E3DEC8B

Sorted:
099340C20A42E004716233AB216761C3 => s2
A0E607462A563C4D8CCDB8194E3DEC8B => s3
C82D4DB065065DBDCDADFBC5A727208E => s1

lookup Key = "mail-23412"
md5("mail-23412") => B91AF709D7C1E6988FCEE7ADF7094A26

So the Value is on machine s3 (first machine with Md5 lower than md5 of key)

Replica:
md5(md5("mail-23412")) => D604E7A54DC18FD7AC70D12468C34B63

So the replica is on machine s1
{% endcodeblock %}


* What if master dies? *Paxos* — distributed leadership election algorithm. Very complicated algorithm that only few people understand.
* The leadership election is solved in OTP (mnesia, gen_leader) and Riak.
* You don't need libraries to write web server. Any fool can write them. But distributed data storage is difficult.

Six rules for building HA systems

1. Isolation
2. Concurrency
3. Failure detection
4. Fault identification
5. Live code upgrade
6. Stable storage

* With stable storage you don't need backups. You need snapshots, because you override the data, but you don't need backups.
* Threads are evil because they share resources.
* We already solved the problem with parallel computing (in Erlang). We are working on detecting bottlenecks now.

### Resources

* Ericsson [SGSN-MME](http://www.ericsson.com/ourportfolio/products/sgsn-mme).
* Rajith Attapattu — 5 reasons why Distributed Systems are hard to program [[blogpost](http://rajith.2rlabs.com/2008/07/23/5-reasons-why-distributed-systems-are-hard-to-develop/)].
* [Chord](http://en.wikipedia.org/wiki/Chord_(peer-to-peer)) algorithm.
* [Paxos](http://en.wikipedia.org/wiki/Paxos_(computer_science)) algorithm.
* Leslie Lamport — Paxos Made Simple [[pdf](http://www.cs.utexas.edu/users/lorenzo/corsi/cs380d/past/03F/notes/paxos-simple.pdf)].
* Thomas Arts, Koen Claessen, Hans Svensson — Semi-formal development of a fault-tolerant leader election protocol in Erlang [[article](http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.101.3220)].
* [Concurix](http://concurix.com) — performance tool for Erlang.


## Erlang beer with Joe Armstrong

<blockquote class="twitter-tweet" align="center"><p>For those who didn&#39;t hear, we&#39;re meeting up at The Public House - 400 N State St <a href="https://twitter.com/search?q=%23LambdaJam&amp;src=hash">#LambdaJam</a></p>&mdash; Garrett Smith (@gar1t) <a href="https://twitter.com/gar1t/statuses/354375863971749888">July 8, 2013</a></blockquote>

This was the best part of the first day.


## John Daily — Distributed Programming with Riak Core and Pipe

* Slides: [GitHub](https://github.com/strangeloop/lambdajam2013/blob/master/slides/Daily-RiakCorePipe.pdf)

Distributed programming is hard (clocks, latency, lost messages, servers break). Use Riak.

### Resources

* Sources: Riak [core](https://github.com/basho/riak_core) and [pipe](https://github.com/basho/riak_pipe).


## Tracy Harms — Semantics, clarity, and notation: the benefits of expressions over statements

<blockquote class="twitter-tweet" align="center"><p><a href="https://twitter.com/search?q=%23LambdaJam&amp;src=hash">#LambdaJam</a> <a href="https://twitter.com/kaleidic">@kaleidic</a>&#39;s &quot;Benefits of Expressions Over Statements&quot; is gold. Brain is barely keeping up.</p>&mdash; Bryan Hunter (@bryan_hunter) <a href="https://twitter.com/bryan_hunter/statuses/354619102792396803">July 9, 2013</a></blockquote>
<blockquote class="twitter-tweet" align="center"><p>This is the example <a href="https://twitter.com/kaleidic">@kaleidic</a> is showing now: <a href="http://t.co/0RMrEGSLt1">http://t.co/0RMrEGSLt1</a> <a href="https://twitter.com/search?q=%23LambdaJam&amp;src=hash">#LambdaJam</a></p>&mdash; Mike English (@gazoombo) <a href="https://twitter.com/gazoombo/statuses/354622989599383552">July 9, 2013</a></blockquote>
<blockquote class="twitter-tweet" align="center"><p>&quot;Expressions condense meaning in space, and eliminate time&quot; ~ <a href="https://twitter.com/kaleidic">@kaleidic</a> <a href="https://twitter.com/search?q=%23LambdaJam&amp;src=hash">#LambdaJam</a></p>&mdash; Mike English (@gazoombo) <a href="https://twitter.com/gazoombo/statuses/354623272249339906">July 9, 2013</a></blockquote>
<blockquote class="twitter-tweet" align="center"><p>&quot;understanding occurs only when meaning is selected and simplified enough for a mind to think about it&quot; ~ <a href="https://twitter.com/kaleidic">@kaleidic</a> <a href="https://twitter.com/search?q=%23LambdaJam&amp;src=hash">#LambdaJam</a></p>&mdash; Mike English (@gazoombo) <a href="https://twitter.com/gazoombo/statuses/354623737460568064">July 9, 2013</a></blockquote>

### Resources

* P. J. Landin — The Next 700 Programming Languages [[pdf](http://www.cs.cmu.edu/~crary/819-f09/Landin66.pdf)]


## Chris Ford — Functional composition

* Video: [YouTube](http://www.youtube.com/watch?v=Mfsnlbd-4xQ) Wait till Aug 26th
* Demo source code: [GitHub](https://github.com/ctford/functional-composition/tree/LambdaJam-2013)

## Clinton Dreisbach — Functional Web Development with Clojure

Liberator — WebMachine in Clojure 


## Gerald Sussman: Keynote

<blockquote class="twitter-tweet" align="center"><p>Gerald Sussman on stage and Joe Armstrong in the front row nodding along. <a href="https://twitter.com/search?q=%23LambdaJam&amp;src=hash">#LambdaJam</a> is a special place. <a href="http://t.co/MuAtry9UGT">http://t.co/MuAtry9UGT</a></p>&mdash; Bryan Hunter (@bryan_hunter) <a href="https://twitter.com/bryan_hunter/statuses/354717953125650432">July 9, 2013</a></blockquote>


## Erlang cocktail

with
[Bryan Hunter](https://twitter.com/bryan_hunter),
[Joe Armstrong](https://twitter.com/joeerl), and
[Kevin Scaldeferri](https://twitter.com/kscaldef)

{% img center https://pbs.twimg.com/media/BOx-YSyCQAAA_TQ.jpg %}

Wonderful ending of the second day.


## Dave Thomas — Living in Big Data with Vector Functional Programming 

extremes - that's what is interesting

language-pimp

eclipse in java

boxing/unboxing slows down

what the function

intellij is the best of worst

<blockquote class="twitter-tweet" align="center"><p>This is the first time I&#39;ve been in the audience of a talk on vector languages. <a href="https://twitter.com/search?q=%23LambdaJam&amp;src=hash">#LambdaJam</a></p>&mdash; Tracy Harms (@kaleidic) <a href="https://twitter.com/kaleidic/statuses/354961117816176642">July 10, 2013</a></blockquote>
<blockquote class="twitter-tweet" align="center"><p>I don&#39;t do Big Data, I don&#39;t have a petabyte in my pocket <a href="https://twitter.com/search?q=%23LambdaJam&amp;src=hash">#LambdaJam</a></p>&mdash; Sean Cribbs (@seancribbs) <a href="https://twitter.com/seancribbs/statuses/354963881480818689">July 10, 2013</a></blockquote>
<blockquote class="twitter-tweet" align="center"><p>OH: I&#39;m an industrial language pimp. <a href="https://twitter.com/search?q=%23LambdaJam&amp;src=hash">#LambdaJam</a></p>&mdash; Sean Cribbs (@seancribbs) <a href="https://twitter.com/seancribbs/statuses/354964642428235777">July 10, 2013</a></blockquote>
<blockquote class="twitter-tweet" align="center"><p>OH: “i’ve got 3 characters on the screen and I have no idea what they’re doing” <a href="https://twitter.com/search?q=%23LambdaJam&amp;src=hash">#LambdaJam</a></p>&mdash; Tom Santero (@tsantero) <a href="https://twitter.com/tsantero/statuses/354966492086935552">July 10, 2013</a></blockquote>
<blockquote class="twitter-tweet" align="center"><p>&quot;What slows languages down is scalars and non-scalars, boxing and unboxing.&quot; - Dave Thomas <a href="https://twitter.com/search?q=%23LambdaJam&amp;src=hash">#LambdaJam</a></p>&mdash; deech (@deech) <a href="https://twitter.com/deech/statuses/354967647219220481">July 10, 2013</a></blockquote>
<blockquote class="twitter-tweet" align="center"><p>&quot;How to learn an array language? Slowly.&quot; ~ Dave Thomas <a href="https://twitter.com/search?q=%23LambdaJam&amp;src=hash">#LambdaJam</a> <a href="http://t.co/CXW5c2e4N1">pic.twitter.com/CXW5c2e4N1</a></p>&mdash; Mike English (@gazoombo) <a href="https://twitter.com/gazoombo/statuses/354970633966333953">July 10, 2013</a></blockquote>
<blockquote class="twitter-tweet" align="center"><p>&quot;Pairing is a great way to learn new things.&quot; ~ Dave Thomas <a href="https://twitter.com/search?q=%23LambdaJam&amp;src=hash">#LambdaJam</a></p>&mdash; Mike English (@gazoombo) <a href="https://twitter.com/gazoombo/statuses/354971652649521155">July 10, 2013</a></blockquote>
<blockquote class="twitter-tweet" align="center"><p>&quot;Most programs, by 2020, will be queries.&quot; ~ Dave Thomas <a href="https://twitter.com/search?q=%23LambdaJam&amp;src=hash">#LambdaJam</a></p>&mdash; Mike English (@gazoombo) <a href="https://twitter.com/gazoombo/statuses/354973047750541312">July 10, 2013</a></blockquote>
<blockquote class="twitter-tweet" align="center"><p>OH: There are five error messages, they are all irritating. <a href="https://twitter.com/search?q=%23LambdaJam&amp;src=hash">#LambdaJam</a></p>&mdash; Sean Cribbs (@seancribbs) <a href="https://twitter.com/seancribbs/statuses/354973815199117312">July 10, 2013</a></blockquote>
<blockquote class="twitter-tweet" align="center"><p>OH: “WTF: what the function? error message” <a href="https://twitter.com/search?q=%23LambdaJam&amp;src=hash">#LambdaJam</a></p>&mdash; Tom Santero (@tsantero) <a href="https://twitter.com/tsantero/statuses/354973859029598208">July 10, 2013</a></blockquote>

## Steve Vinoski — Addressing Network Congestion in Riak Clusters


## Mahesh Paolini-Subramanya — Finite State Machines. Why the fear?

<blockquote class="twitter-tweet" align="center"><p>Write a project in C++ or Java and you’re creating work for 5 other devs. Write it in Erlang and you’re done <a href="https://twitter.com/dieswaytoofast">@dieswaytoofast</a> <a href="https://twitter.com/search?q=%23LambdaJam&amp;src=hash">#LambdaJam</a></p>&mdash; John Daily (@macintux) <a href="https://twitter.com/macintux/statuses/354989456320774144">July 10, 2013</a></blockquote>
<blockquote class="twitter-tweet" align="center"><p>Sitting behind <a href="https://twitter.com/webyrd">@webyrd</a>, <a href="https://twitter.com/dfried00">@dfried00</a>, Sussman, and <a href="https://twitter.com/joeerl">@joeerl</a> in <a href="https://twitter.com/dieswaytoofast">@dieswaytoofast</a>&#39;s finite state machine talk. <a href="https://twitter.com/search?q=%23LambdaJam&amp;src=hash">#LambdaJam</a> <a href="http://t.co/BtueYuWHtQ">pic.twitter.com/BtueYuWHtQ</a></p>&mdash; Mike English (@gazoombo) <a href="https://twitter.com/gazoombo/statuses/354991392247906305">July 10, 2013</a></blockquote>
<blockquote class="twitter-tweet" align="center"><p>&quot;There&#39;s a special place in hell for the people who came up with [the Oauth 2.0 spec]&quot; ~ <a href="https://twitter.com/dieswaytoofast">@dieswaytoofast</a> <a href="https://twitter.com/search?q=%23LambdaJam&amp;src=hash">#LambdaJam</a></p>&mdash; Mike English (@gazoombo) <a href="https://twitter.com/gazoombo/statuses/354992769212743682">July 10, 2013</a></blockquote>
<blockquote class="twitter-tweet" align="center"><p>Everything is an FSM. Problem with actually modeling this is complexity of large FSMs. Answer is encapsulation. -<a href="https://twitter.com/dieswaytoofast">@dieswaytoofast</a> <a href="https://twitter.com/search?q=%23LambdaJam&amp;src=hash">#LambdaJam</a></p>&mdash; Mike English (@gazoombo) <a href="https://twitter.com/gazoombo/statuses/354995630571139072">July 10, 2013</a></blockquote>
<blockquote class="twitter-tweet" align="center"><p>Design your system as a big FSM that is a collection of little FSMs. Only transition between them as needed. - <a href="https://twitter.com/dieswaytoofast">@dieswaytoofast</a> <a href="https://twitter.com/search?q=%23LambdaJam&amp;src=hash">#LambdaJam</a></p>&mdash; Mike English (@gazoombo) <a href="https://twitter.com/gazoombo/statuses/354996445818003456">July 10, 2013</a></blockquote>





## Sean Cribbs, Chris Meiklejohn — Functional Web Applications with Webmachine

The keyword here is *Functional*.

* Slides: [GitHub](https://github.com/strangeloop/lambdajam2013/blob/master/slides/CribbsMeiklejohn-Webmachine.pdf)
* Tutorial: [GitHub](https://github.com/cmeiklejohn/webmachine-tutorial)
* Webmachine [diagram](https://github.com/basho/webmachine/wiki/Diagram)

{% codeblock lang:bash %}
git clone git@github.com:cmeiklejohn/webmachine-tutorial.git
{% endcodeblock %}

{% img center /images/posts/webmachine-diagram.png %}

{% codeblock lang:bash %}
git checkout hello-world
{% endcodeblock %}

* f(ReqData,State) -> {RetV,ReqData,State}.
* `iolist()`

{% codeblock lang:erlang src/tweeter_resource.erl %}
init([]) ->
    {ok, []}.

to_html(ReqData, State) ->
    {["<html><body>", wrq:get_req_header("host", ReqData), "</body></html>"],
     ReqData,
     State}.
{% endcodeblock %}

Supervisor: resources, routes, dispatch

    git checkout -f load-tweets

{% codeblock lang:erlang src/tweeter_sup.erl %}
init([]) ->
    ...
    Resources = [tweeter_wm_tweet_resource, tweeter_wm_asset_resource],
    Dispatch = lists:flatten([Module:routes() || Module <- Resources]),
    ...
{% endcodeblock %}

{% codeblock lang:erlang src/tweeter_wm_tweet_resource.erl %}
routes() ->
    [{["tweets"], ?MODULE, []}].
{% endcodeblock %}

{% codeblock lang:erlang src/tweeter_wm_asset_resource.erl %}
routes() ->
    [{[""], ?MODULE, []}, {['*'], ?MODULE, []}].
{% endcodeblock %}

Media Types

{% codeblock lang:erlang src/tweeter_wm_tweet_resource.erl %}
content_types_provided(ReqData, Context) ->
    {[{"application/json", to_json},
      {"application/x-erlang-binary", to_erlang}], ReqData, Context}.

to_json(ReqData, Context) ->
    Tweets = [Value || [{_Key, Value}] <- ets:match(tweets, '$1')],
    Content = mochijson2:encode({struct, [{tweets, Tweets}]}),
    {Content, ReqData, Context}.

to_erlang(ReqData, Context) ->
    Tweets = [Value || [{_Key, Value}] <- ets:match(tweets, '$1')],
    Content = term_to_binary(Tweets),
    {Content, ReqData, Context}.
{% endcodeblock %}

{% codeblock %}
$ curl -i -H "Accept:application/x-erlang-binary" "http://localhost:8080/tweets"
HTTP/1.1 200 OK
Vary: Accept
Server: MochiWeb/1.1 WebMachine/1.10.0 (never breaks eye contact)
Content-Type: application/x-erlang-binary

?llhdavatarmZhttps://si0.twimg.com/profile_images/2536088319/4sl2go65was3o0km520j_reasonably_small.jpeghdmessageCaremad.jlhdavatarm\https://si0.twimg.com/profile_images/3778090444/e4fde2cad4b921cd8c07fcecc0ff2fff_bigger.jpeghdmessagemRubby is over!jlhdavatarmZhttps://si0.twimg.com/profile_images/2536088319/4sl2go65was3o0km520j_reasonably_small.jpeghdmessagemYou boys having a taste?jj
{% endcodeblock %}

`resource_exists`

    git checkout -f tweet-urls

{% codeblock lang:erlang src/tweeter_wm_tweet_resource.erl %}
routes() ->
    [{["tweets", tweet_id], ?MODULE, []}].

tweet_id(ReqData) ->
    time_from_timestamp(wrq:path_info(tweet_id, ReqData)).

resource_exists(ReqData, Context) ->
    case maybe_retrieve_tweet(Context, tweet_id(ReqData)) of
        {true, NewContext} -> {true, ReqData, NewContext};
        {false, Context}   -> {false, ReqData, Context}
    end.
{% endcodeblock %}

{% codeblock %}
$ curl http://localhost:8080/tweets
{"tweets":[
  {"avatar":"https://si0.twimg.com/profile_images/2536088319/4sl2go65was3o0km520j_reasonably_small.jpeg","message":"Caremad.","id":"1376843311536798"},
  {"avatar":"https://si0.twimg.com/profile_images/3778090444/e4fde2cad4b921cd8c07fcecc0ff2fff_bigger.jpeg","message":"Rubby is over!","id":"1376843311536799"},
  {"avatar":"https://si0.twimg.com/profile_images/2536088319/4sl2go65was3o0km520j_reasonably_small.jpeg","message":"You boys having a taste?","id":"1376843311536800"}]}
{% endcodeblock %}

{% codeblock %}
$ curl -i http://localhost:8080/tweets/1376843311536798
HTTP/1.1 200 OK

{"tweet":{"avatar":"https://si0.twimg.com/profile_images/2536088319/4sl2go65was3o0km520j_reasonably_small.jpeg","message":"Caremad."}}
{% endcodeblock %}

{% codeblock %}
$ curl -i http://localhost:8080/tweets/42
HTTP/1.1 404 Object Not Found

<HTML><HEAD><TITLE>404 Not Found</TITLE></HEAD><BODY><H1>Not Found</H1>The requested document was not found on this server.<P><HR><ADDRESS>mochiweb+webmachine web server</ADDRESS></BODY></HTML>
{% endcodeblock %}

`POST`, response header

    git checkout -f create-tweets

{% codeblock lang:erlang src/tweeter_wm_tweets_resource.erl %}
allowed_methods(ReqData, Context) ->
    {['HEAD', 'GET', 'POST'], ReqData, Context}.

post_is_create(ReqData, Context) ->
    {true, ReqData, Context}.

create_path(ReqData, Context) ->
    case maybe_create_tweet(ReqData, Context) of
        {true, NewContext} ->
            {Id, _} = NewContext#context.tweet,
            Resource = "/tweets/" ++ binary_to_list(time_to_timestamp(Id)),
            NewReqData = wrq:set_resp_header("Location", Resource, ReqData),
            {Resource, NewReqData, NewContext};
        {false, Context} ->
            {"/users", ReqData, Context}
    end.

content_types_accepted(ReqData, Context) ->
    {[{"application/json", from_json}], ReqData, Context}.

from_json(ReqData, Context) ->
    case maybe_create_tweet(ReqData, Context) of
        {true, NewContext} ->
            {_, Tweet} = NewContext#context.tweet,
            Response = mochijson2:encode({struct, [{tweet, Tweet}]}),
            NewReqData = wrq:set_resp_body(Response, ReqData),
            {true, NewReqData, NewContext};
        {false, Context} ->
            { {halt, 409}, ReqData, Context}
    end.
{% endcodeblock %}

{% codeblock %}
$ curl -i -X POST -H "Content-Type:application/json" \
      http://localhost:8080/tweets --data @-
{
  "tweet":{
    "message":"testing...",
    "avatar":"https://si0.twimg.com/profile_images/3778090444/e4fde2cad4b921cd8c07fcecc0ff2fff_bigger.jpeg"
  }
}
HTTP/1.1 201 Created
Location: /tweets/1376847941255278
Content-Type: application/json

{"tweet":{"message":"testing...","avatar":"https://si0.twimg.com/profile_images/3778090444/e4fde2cad4b921cd8c07fcecc0ff2fff_bigger.jpeg"}}
{% endcodeblock %}

{% codeblock %}
$ curl -i -X POST -H "Content-Type:application/xml" \
      http://localhost:8080/tweets --data @-
{
  "tweet":{
    "message":"testing...",
    "avatar":"https://si0.twimg.com/profile_images/3778090444/e4fde2cad4b921cd8c07fcecc0ff2fff_bigger.jpeg"
  }
}
HTTP/1.1 415 Unsupported Media Type
Location: /tweets/1376848621307991
Content-Type: text/html

<html><head><title>415 Unsupported Media Type</title></head><body><h1>Unsupported Media Type</h1>Unsupported Media Type<p><hr><address>mochiweb+webmachine web server</address></body></html>
{% endcodeblock %}

Note: `create_path` is called before `content_types_accepted`

{% codeblock %}
$ curl -i -X POST -H "Content-Type:application/xml" \
      http://localhost:8080/tweets --data @-
<tweet>
  <message>testing...</message>
  <avatar>https://si0.twimg.com/profile_images/3778090444/e4fde2cad4b921cd8c07fcecc0ff2fff_bigger.jpeg</avatar>
</tweet>
HTTP/1.1 500 Internal Server Error
Content-Type: text/html

<html><head><title>500 Internal Server Error</title></head><body><h1>Internal Server Error</h1>The server encountered an error while processing this request:<br><pre>{"create_path not a string",
 {error,
     {...}}}</pre><P><HR><ADDRESS>mochiweb+webmachine web server</ADDRESS></body></html>
{% endcodeblock %}

ETags, caching, preconditions

    git checkout -f etag-tweets

{% codeblock lang:erlang src/tweeter_wm_tweets_resource.erl %}
generate_etag(ReqData, Context) ->
    {_, NewContext} =  maybe_retrieve_tweets(Context),
    ETag = mochihex:to_hex(erlang:phash2(NewContext#context.tweets)),
    {ETag, ReqData, NewContext}.

last_modified(ReqData, Context) ->
    Id = ets:last(tweets),
    {calendar:now_to_datetime(Id), ReqData, Context}.
{% endcodeblock %}

{% codeblock %}
$ curl -i http://localhost:8080/tweets
HTTP/1.1 200 OK
Last-Modified: Sun, 18 Aug 2013 21:44:50 GMT
ETag: "30008d7"

{"tweets":[
  {"avatar":"https://si0.twimg.com/profile_images/2536088319/4sl2go65was3o0km520j_reasonably_small.jpeg","message":"Caremad.","id":"1376860726482913"},
  {"avatar":"https://si0.twimg.com/profile_images/3778090444/e4fde2cad4b921cd8c07fcecc0ff2fff_bigger.jpeg","message":"Rubby is over!","id":"1376860726482914"},
  {"avatar":"https://si0.twimg.com/profile_images/2536088319/4sl2go65was3o0km520j_reasonably_small.jpeg","message":"You boys having a taste?","id":"1376860726482915"}]}
{% endcodeblock %}

{% codeblock %}
$ curl -i -H 'If-None-Match:"30008d7"' http://localhost:8080/tweets
HTTP/1.1 304 Not Modified
ETag: "30008d7"
{% endcodeblock %}

{% codeblock %}
$ curl -i -H 'If-Modified-Since:Sun, 18 Aug 2013 21:45:41 GMT' http://localhost:8080/tweets
HTTP/1.1 304 Not Modified
ETag: "30008d7"
{% endcodeblock %}

Authorization, CSRF

    git checkout -f csrf

{% codeblock lang:erlang src/tweeter_wm_tweets_resource.erl %}
forbidden(ReqData, Context) ->
    {tweeter_security:is_protected(ReqData, Context), ReqData, Context}.
{% endcodeblock %}

Visual debugger

    git checkout -f debugger

{% codeblock lang:erlang src/tweeter_wm_asset_resource.erl %}
init([]) ->
    wmtrace_resource:add_dispatch_rule("wmtrace", "/tmp"),
    { {trace, "/tmp"}, #context{}}.
{% endcodeblock %}

{% img center /images/posts/webmachine-debugger-1.png %}

{% img center /images/posts/webmachine-debugger-2.png %}

ErlyDTL, Dialyzer

### Resources

* Webmachine: [Request Data API](https://github.com/basho/webmachine/wiki/Request-Data-API)
* James Hague — A Ramble Through Erlang IO Lists [[blogpost](http://prog21.dadgum.com/70.html)]
* Andrei Neculau — [http-decision-diagram](https://github.com/andreineculau/http-decision-diagram)


## David Nolen — Keynote

* Slides: [GitHub](https://github.com/strangeloop/lambdajam2013/blob/master/slides/Nolen-EverythingIHaveLearned.pdf)

## Bonus 1: Joe Armstrong @ CEUG — 26 Years With Erlang

<iframe width="100%" height="480" src="//www.youtube.com/embed/HCwRGHj5jOE" />


## Bonus 2: Joe Armstrong @ CEUG — Sherlock's Last Case

<iframe width="100%" height="480" src="//www.youtube.com/embed/hh4tmDB9iQI" />


## Key concepts learnt

* Data transformation
* Problems with distributed computing and data


## Epilogue

<blockquote class="twitter-tweet" align="center"><p>As I leave <a href="https://twitter.com/search?q=%23LambdaJam&amp;src=hash">#LambdaJam</a> I&#39;m particularly happy at my improved sense of being able to think about OO stuff in FP terms. That may serve me well.</p>&mdash; Tracy Harms (@kaleidic) <a href="https://twitter.com/kaleidic/statuses/355327906764959744">July 11, 2013</a></blockquote>
<blockquote class="twitter-tweet" align="center"><p>Life returning to normal. Have been suffering for PCSD (Post Conference Stress Disorder) - too many ideas in too short time + Jet Lag</p>&mdash; Joe Armstrong (@joeerl) <a href="https://twitter.com/joeerl/statuses/356672073675972609">July 15, 2013</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


