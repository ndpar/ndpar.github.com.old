---
layout:     post
title:      "Spring OAuth 2"
date:       2016-12-24 18:11:35
categories: [OAuth,Spring]
tags:       [oauth,spring]
published:  true
---

This post is a quick analysis of the Spring implementation of OAuth 2.0 code
flow ([RFC6749 Section 4.1][1]) with the minumum application [code][2].
The setup consists of the [authorization server][s], the [resource server][r],
and the [client][c].

The flow starts when a user hits
[localhost:9999/client/resource](http://localhost:9999/client/resource)

{% img center /images/posts/spring-oauth-sequence.png %}

<!-- More -->

{% codeblock 1 %}
GET /client/resource HTTP/1.1
Host: localhost:9999
{% endcodeblock %}

Client endpoints are protected by Spring Security, therefore it redirects the
request to `login` endpoint

{% codeblock 2 %}
HTTP/1.1 302
Set-Cookie: JSESSIONID=67CB7BD60760EDD84BD0884FF9F09651;path=/client;HttpOnly
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Cache-Control: no-cache, no-store, max-age=0, must-revalidate
Pragma: no-cache
Expires: 0
X-Frame-Options: DENY
Location: http://localhost:9999/client/login
Content-Length: 0
{% endcodeblock %}

Browser tries to load `login` page

{% codeblock 3 %}
GET /client/login HTTP/1.1
Host: localhost:9999
Cookie: JSESSIONID=67CB7BD60760EDD84BD0884FF9F09651
{% endcodeblock %}

Client delegates the authorization to OAuth server

{% codeblock 4 %}
HTTP/1.1 302
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Cache-Control: no-cache, no-store, max-age=0, must-revalidate
Pragma: no-cache
Expires: 0
X-Frame-Options: DENY
Location: http://localhost:8080/oauth/authorize?client_id=my-trusted-client&redirect_uri=http://localhost:9999/client/login&response_type=code&state=JUkFF6
Content-Length: 0
{% endcodeblock %}

[OAuth flow][rfc6749#4.1.1] technically starts here. `state` is randomly
generated by Spring. `client_id` is configured in Client's application
[properties][c.a.yml].

{% codeblock 5 %}
GET /oauth/authorize?client_id=my-trusted-client&redirect_uri=http://localhost:9999/client/login&response_type=code&state=JUkFF6 HTTP/1.1
Host: localhost:8080
{% endcodeblock %}

Since User is not authenticated yet Spring shows basic dialog asking for user
name and password.

{% codeblock 6 %}
HTTP/1.1 401
WWW-Authenticate: Basic realm="Spring"
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Cache-Control: no-cache, no-store, max-age=0, must-revalidate
Pragma: no-cache
Expires: 0
X-Frame-Options: DENY
Strict-Transport-Security: max-age=31536000 ; includeSubDomains
Content-Type: text/html;charset=UTF-8
Content-Language: en-US
Content-Length: 344
{% endcodeblock %}

User types `dave`:`secret`. These are credentials stored in Server [database][s.d.sql].

{% img center /images/posts/oauth-auth.png %}

`Authorization` header here contains User credentials.

{% codeblock 7 %}
GET /oauth/authorize?client_id=my-trusted-client&redirect_uri=http://localhost:9999/client/login&response_type=code&state=JUkFF6 HTTP/1.1
Host: localhost:8080
Authorization: Basic ZGF2ZTpzZWNyZXQ=
{% endcodeblock %}

Server verifies User credentials and creates session.

{% codeblock 8 %}
HTTP/1.1 200
Set-Cookie: JSESSIONID=0517E6F4E263721C8E75A1378D51179F;path=/;HttpOnly
Cache-Control: no-store
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
X-Frame-Options: DENY
Strict-Transport-Security: max-age=31536000 ; includeSubDomains
Content-Type: text/html;charset=UTF-8
Content-Language: en-US
Content-Length: 573
{% endcodeblock %}

The authorization page gives User a choice to authorize or deny Client.

{% img center /images/posts/oauth-approval.png %}

User clicks `Authorize` button.

{% codeblock 9 %}
POST /oauth/authorize HTTP/1.1
Host: localhost:8080
Content-Length: 44
Authorization: Basic ZGF2ZTpzZWNyZXQ=
Origin: http://localhost:8080
Content-Type: application/x-www-form-urlencoded
Referer: http://localhost:8080/oauth/authorize?client_id=my-trusted-client&redirect_uri=http://localhost:9999/client/login&response_type=code&state=JUkFF6
Cookie: JSESSIONID=0517E6F4E263721C8E75A1378D51179F

Form item: "user_oauth_approval" = "true"
Form item: "authorize" = "Authorize"
{% endcodeblock %}

Server creates a new session, generates a random `code`, and redirects the
response to `redirect_uri` supplied on step 7.

{% codeblock 10 %}
HTTP/1.1 302
Set-Cookie: JSESSIONID=6503F28F4068C83EC7BE0F5EC163D06F;path=/;HttpOnly
Cache-Control: no-store
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
X-Frame-Options: DENY
Strict-Transport-Security: max-age=31536000 ; includeSubDomains
Location: http://localhost:9999/client/login?code=WEJz0f&state=JUkFF6
Content-Language: en-US
Content-Length: 0
{% endcodeblock %}

Browser, with Client and Server sessions saved in cookies, gets the redirected Client URI.

{% codeblock 11 %}
GET /client/login?code=WEJz0f&state=JUkFF6 HTTP/1.1
Host: localhost:9999
Referer: http://localhost:8080/oauth/authorize?client_id=my-trusted-client&redirect_uri=http://localhost:9999/client/login&response_type=code&state=JUkFF6
Cookie: JSESSIONID=67CB7BD60760EDD84BD0884FF9F09651; JSESSIONID=6503F28F4068C83EC7BE0F5EC163D06F
{% endcodeblock %}

Spring OAuth Client requests access token implementing
[RFC6749 Section 4.1.3][rfc6749#4.1.3]. Client authenticates itself through
`Authorization` header passing credentials configured in Client application
[properties][c.a.yml].

{% codeblock 12 %}
POST /oauth/token HTTP/1.1
Authorization: Basic bXktdHJ1c3RlZC1jbGllbnQ6bXktdHJ1c3RlZC1jbGllbnQtcGFzcw==
Accept: application/json, application/x-www-form-urlencoded
Content-Type: application/x-www-form-urlencoded
Cache-Control: no-cache
Pragma: no-cache
User-Agent: Java/1.8.0_112
Host: localhost:8080
Connection: keep-alive
Content-Length: 101

Form item: "grant_type" = "authorization_code"
Form item: "code" = "WEJz0f"
Form item: "redirect_uri" = "http://localhost:9999/client/login"
{% endcodeblock %}

Server verifies Client credentials stored in the [database][s.d.sql] and
exchanges authorization code for access token implementing
[RFC6749 Section 4.1.4][rfc6749#4.1.4]. `scope` is populated from the
corresponding database column.

{% codeblock 13 %}
HTTP/1.1 200
Cache-Control: no-store
Pragma: no-cache
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
X-Frame-Options: DENY
Content-Type: application/json;charset=UTF-8

{
  access_token: 16d91f9e-69c5-41a9-bd0f-df8308589784,
  token_type: bearer,
  refresh_token: 8a283a19-7524-43d7-95bd-bc3a76260f3d,
  expires_in: 59,
  scope: read write trust
}
{% endcodeblock %}

Although it's not a part of RFC6749, Client sends access token verification
request to Server. Once again Client authenticates itself through
`Authorization` header.

{% codeblock 14 %}
POST /oauth/check_token HTTP/1.1
Accept: application/json, application/*+json
Authorization: Basic bXktdHJ1c3RlZC1jbGllbnQ6bXktdHJ1c3RlZC1jbGllbnQtcGFzcw==
Content-Type: application/x-www-form-urlencoded
User-Agent: Java/1.8.0_112
Host: localhost:8080

Form item: "token" = "16d91f9e-69c5-41a9-bd0f-df8308589784"
{% endcodeblock %}

Server verifies Client credentials and access token and responds with User/Client metadata.

{% codeblock 15 %}
HTTP/1.1 200
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Cache-Control: no-cache, no-store, max-age=0, must-revalidate
Pragma: no-cache
Expires: 0
X-Frame-Options: DENY
Content-Type: application/json;charset=UTF-8

{
  exp: 1481467593
  user_name: dave
  authorities: [ROLE_USER]
  client_id: my-trusted-client
  scope: [read, write, trust]
}
{% endcodeblock %}

Client redirects User browser to the URL requested initially on step 1. It also
resets the session.

{% codeblock 16 %}
HTTP/1.1 302
Set-Cookie: JSESSIONID=460BEFFA884E6349212F8D2EA50BF776;path=/client;HttpOnly
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Cache-Control: no-cache, no-store, max-age=0, must-revalidate
Pragma: no-cache
Expires: 0
X-Frame-Options: DENY
Location: http://localhost:9999/client/resource
{% endcodeblock %}

This step is the same as step 1 but with valid Client and Server sessions.

{% codeblock 17 %}
GET /client/resource HTTP/1.1
Host: localhost:9999
Referer: http://localhost:8080/oauth/authorize?client_id=my-trusted-client&redirect_uri=http://localhost:9999/client/login&response_type=code&state=JUkFF6
Cookie: JSESSIONID=460BEFFA884E6349212F8D2EA50BF776; JSESSIONID=6503F28F4068C83EC7BE0F5EC163D06F
{% endcodeblock %}

As a part of business logic [Client][c.38-41] sends a request to Resource
server suppling bearer token as required by [RFC6750 Section 2][rfc6750#2].

{% codeblock 18 %}
GET /me HTTP/1.1
Authorization: bearer 16d91f9e-69c5-41a9-bd0f-df8308589784
Accept: text/plain, application/json, application/*+json, */*
User-Agent: Java/1.8.0_112
Host: localhost:8888
{% endcodeblock %}

Resource server calls OAuth Server to verify the access token implementing
[RFC7662 Section 2.1][rfc7662#2.1]. Resource authenticates itself through
`Authorization` header suppling credentials configured in its application
[properties][r.a.yml].

{% codeblock 19 %}
POST /oauth/check_token HTTP/1.1
Accept: application/json, application/*+json
Authorization: Basic bXktcmVzb3VyY2U6bXktcmVzb3VyY2UtcGFzcw==
Content-Type: application/x-www-form-urlencoded
User-Agent: Java/1.8.0_112
Host: localhost:8080

Form item: "token" = "16d91f9e-69c5-41a9-bd0f-df8308589784"
{% endcodeblock %}

Server verifies Resource credentials and access token and responds with
User/Client metadata.

{% codeblock 20 %}
HTTP/1.1 200
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Cache-Control: no-cache, no-store, max-age=0, must-revalidate
Pragma: no-cache
Expires: 0
X-Frame-Options: DENY
Content-Type: application/json;charset=UTF-8

{
  exp: 1481467593
  user_name: dave
  authorities: [ROLE_USER]
  client_id: my-trusted-client
  scope: [read, write, trust]
}
{% endcodeblock %}

Since the access token is valid Resource server replies to Client

{% codeblock 21 %}
HTTP/1.1 200
Set-Cookie: JSESSIONID=4D7F3BE1EFD37A99D9878A0037A0F8A5;path=/;HttpOnly
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Cache-Control: no-cache, no-store, max-age=0, must-revalidate
Pragma: no-cache
Expires: 0
X-Frame-Options: DENY
Content-Type: application/json;charset=UTF-8

{name:dave}
{% endcodeblock %}

Client returns the response to User

{% codeblock 22 %}
HTTP/1.1 200
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Cache-Control: no-cache, no-store, max-age=0, must-revalidate
Pragma: no-cache
Expires: 0
X-Frame-Options: DENY
Content-Type: text/html;charset=UTF-8
{% endcodeblock %}

## Specifications

- [**RFC6749**](https://tools.ietf.org/html/rfc6749) The OAuth 2.0 Authorization Framework
- [**RFC6750**](https://tools.ietf.org/html/rfc6750) The OAuth 2.0 Authorization Framework: Bearer Token Usage
- [**RFC6819**](https://tools.ietf.org/html/rfc6819) OAuth 2.0 Threat Model and Security Considerations
- [**RFC7009**](https://tools.ietf.org/html/rfc7009) OAuth 2.0 Token Revocation
- [**RFC7591**](https://tools.ietf.org/html/rfc7591) OAuth 2.0 Dynamic Client Registration Protocol
- [**RFC7636**](https://tools.ietf.org/html/rfc7636) PKCE by OAuth Public Clients
- [**RFC7662**](https://tools.ietf.org/html/rfc7662) OAuth 2.0 Token Introspection


[1]: https://tools.ietf.org/html/rfc6749#section-4.1
[2]: https://github.com/ndpar/oauth-demo

[s]: https://github.com/ndpar/oauth-demo/blob/master/server/src/main/java/com/ndpar/ServerApplication.java
[r]: https://github.com/ndpar/oauth-demo/blob/master/resource/src/main/java/com/ndpar/ResourceApplication.java
[c]: https://github.com/ndpar/oauth-demo/blob/master/client/src/main/java/com/ndpar/ClientApplication.java
[c.38-41]: https://github.com/ndpar/oauth-demo/blob/master/client/src/main/java/com/ndpar/ClientApplication.java#L38-L41

[c.a.yml]: https://github.com/ndpar/oauth-demo/blob/master/client/src/main/resources/application.yml
[s.d.sql]: https://github.com/ndpar/oauth-demo/blob/master/server/src/main/resources/data.sql
[r.a.yml]: https://github.com/ndpar/oauth-demo/blob/master/resource/src/main/resources/application.yml

[rfc6749#4.1.1]: https://tools.ietf.org/html/rfc6749#section-4.1.1
[rfc6749#4.1.3]: https://tools.ietf.org/html/rfc6749#section-4.1.3
[rfc6749#4.1.4]: https://tools.ietf.org/html/rfc6749#section-4.1.4
[rfc6750#2]: https://tools.ietf.org/html/rfc6750#section-2
[rfc7662#2.1]: https://tools.ietf.org/html/rfc7662#section-2.1
